<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>เข้าร่วมกิจกรรม</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root{--p:#003087;--a:#0066ff;--success:#00c853;--shadow:0 25px 60px rgba(0,48,135,.22);--radius:22px;}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,#f0f4ff,#d0e8ff);min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:20px 10px;}
        .c{background:#fff;max-width:500px;width:100%;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
        .h{background:linear-gradient(135deg,var(--p),#0052cc);color:#fff;padding:40px 24px;text-align:center;}
        .h h2{font-size:2.1rem;font-weight:800}.h p{margin-top:10px;font-size:1.15rem;opacity:.95}
        .ct{padding:32px 28px 40px;}
        #i{width:100%;padding:22px 24px;font-size:1.55rem;border:2px solid #ddd;border-radius:18px;transition:all .2s;}
        #i:focus{outline:none;border-color:var(--a);box-shadow:0 0 0 6px rgba(0,102,255,.2);}
        
        /* ปุ่มยืนยันตัวใหญ่ */
        #confirmBtn{
            margin-top:20px;
            width:100%;
            padding:22px;
            font-size:1.7rem;
            font-weight:800;
            background:var(--success);
            color:white;
            border:none;
            border-radius:20px;
            cursor:pointer;
            opacity:0.3;
            transition:all .3s;
            box-shadow:0 10px 30px rgba(0,200,83,.4);
        }
        #confirmBtn.active{
            opacity:1;
            transform:translateY(-2px);
            box-shadow:0 15px 40px rgba(0,200,83,.5);
        }
        #confirmBtn:active{transform:scale(0.96)}

        /* รายการผลการค้นหา */
        #r{
            position:absolute;
            top:100%; left:50%; transform:translateX(-50%);
            width:calc(100% - 40px);
            max-height:55vh;
            background:#fff;
            border-radius:20px;
            border:3px solid var(--a);
            box-shadow:var(--shadow);
            overflow-y:auto;
            z-index:9999;
            opacity:0; visibility:hidden;
            transition:all .25s ease;
        }
        #r.show{opacity:1; visibility:visible; transform:translateX(-50%) translateY(8px);}

        .ri{
            padding:24px 28px;
            border-bottom:1px solid #eee;
            cursor:pointer;
            transition:all .15s;
        }
        .ri:hover{background:#f0f8ff;}
        .ri.selected{background:#e3f2fd !important; border-left:6px solid var(--a);}

        .n{font-size:1.4rem; font-weight:700; color:#1e293b;}
        .d{font-size:1.15rem; color:#555; margin-top:6px;}

        /* ผลลัพธ์ */
        #res{
            margin-top:24px;
            padding:24px;
            border-radius:16px;
            text-align:center;
            font-weight:600;
            min-height:80px;
            transition:all .4s;
        }
        .info{background:#fffde7; color:#e65100; border:2px solid #ffe082;}
        .success{background:#e8f5e8; color:#155724; border:2px solid #c3e6cb;}
        .error{background:#fdecea; color:#c62828; border:2px solid #ef9a9a;}
        .loading{background:#ebf3ff; color:var(--p); border:2px dashed #90caf9;}

        .success-card{
            animation:pop 0.6s ease;
        }
        @keyframes pop{0%{transform:scale(0.4);opacity:0}70%{transform:scale(1.1)}100%{transform:scale(1)}}
    </style>
</head>
<body>

<div class="c">
  <div class="h">
    <h2>เข้าร่วมกิจกรรม</h2>
    <p>กองทุนสำรองเลี้ยงชีพ</p>
  </div>

  <div class="ct">
    <div style="position:relative">
      <input type="text" id="i" placeholder="พิมพ์ชื่อหรือรหัสพนักงาน" autocomplete="off" autofocus>
      <ul id="r"></ul>
    </div>

    <button id="confirmBtn">ลงทะเบียน</button>

    <div id="res" class="info">กรุณาพิมพ์ชื่อหรือรหัสพนักงาน</div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzb6vYis20nG_t3vVSqg8GoEi-N8dPWXMC1Vis_vWYW7duvdKnIFl0mfsx10KWqVoSJ/exec";
const input = document.getElementById('i');
const list = document.getElementById('r');
const btn = document.getElementById('confirmBtn');
const resDiv = document.getElementById('res');

let selectedPerson = null;

input.addEventListener('input', () => {
  clearTimeout(window.st);
  window.st = setTimeout(search, 150);
});

input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && selectedPerson) {
    e.preventDefault();
    btn.click();  // กด Enter = กดปุ่มเลย
  }
});

btn.onclick = () => {
  if (!selectedPerson) return;
  checkin(selectedPerson.id, selectedPerson.name, selectedPerson.dept);
};

async function search() {
  const q = input.value.trim();
  list.innerHTML = '';
  list.classList.remove('show');
  selectedPerson = null;
  btn.classList.remove('active');
  btn.textContent = "ลงทะเบียน";

  if (q.length < 1) {
    resDiv.textContent = "กรุณาพิมพ์ชื่อหรือรหัสพนักงาน";
    resDiv.className = "info";
    return;
  }

  resDiv.textContent = "กำลังค้นหา...";
  resDiv.className = "loading";

  try {
    const r = await fetch(`${WEB_APP_URL}?action=search&q=${encodeURIComponent(q)}`);
    const data = await r.json();

    if (!data || data.length === 0) {
      resDiv.textContent = "ไม่พบข้อมูล";
      resDiv.className = "error";
      return;
    }

    data.slice(0,15).forEach(person => {
      const li = document.createElement('li');
      li.className = 'ri';
      li.innerHTML = `<div class="n">${person.name}</div><div class="d">รหัส: ${person.id} | แผนก: ${person.dept}</div>`;
      li.onclick = () => {
        selectedPerson = person;
        input.value = person.name;
        list.innerHTML = '';
        list.classList.remove('show');
        
        btn.classList.add('active');
        btn.innerHTML = `<i class="fas fa-user-check"></i> ลงทะเบียน: ${person.name.split(' ')[0]} (${person.id})`;
        
        resDiv.innerHTML = `<strong>เลือกแล้ว:</strong> ${person.name}<br><small>รหัส ${person.id} • ${person.dept}</small>`;
        resDiv.className = "success";
      };
      list.appendChild(li);
    });

    list.classList.add('show');
    resDiv.textContent = `พบ ${data.length} คน เลือกชื่อแล้วกดปุ่มสีเขียว`;
    resDiv.className = "info";

  } catch(e) {
    resDiv.textContent = "เชื่อมต่อไม่ได้";
    resDiv.className = "error";
  }
}

async function checkin(id, name, dept) {
  btn.disabled = true;
  btn.innerHTML = "กำลังบันทึก...";
  resDiv.innerHTML = `กำลังบันทึก <strong>${name}</strong>...`;
  resDiv.className = "loading";

  try {
    const r = await fetch(`${WEB_APP_URL}?action=checkin&id=${id}&t=${Date.now()}`);
    const result = await r.json();

    if (result.status === 'success') {
      resDiv.innerHTML = `
        <div class="success-card" style="padding:20px;margin-top:10px;">
          <div style="font-size:4rem;color:var(--success);">✓</div>
          <div style="font-size:2rem;font-weight:800;margin:10px 0;color:#155724;">${name}</div>
          <div style="font-size:1.3rem;color:#2e7d32;">ลงทะเบียนสำเร็จ!</div>
        </div>`;
      resDiv.className = "success";

      setTimeout(() => {
        input.value = '';
        selectedPerson = null;
        btn.classList.remove('active');
        btn.textContent = "ลงทะเบียน";
        btn.disabled = false;
        input.focus();
        resDiv.textContent = "กรุณาพิมพ์ชื่อหรือรหัสพนักงาน";
        resDiv.className = "info";
      }, 800);

    } else {
      throw result.message || "error";
    }
  } catch(e) {
    resDiv.textContent = "บันทึกไม่สำเร็จ ลองใหม่";
    resDiv.className = "error";
    btn.disabled = false;
    btn.innerHTML = `<i class="fas fa-user-check"></i> ลงทะเบียน: ${name.split(' ')[0]}`;
  }
}

// ปิด dropdown เมื่อคลิกนอก
document.addEventListener('click', e => {
  if (!e.target.closest('input') && !e.target.closest('#r')) {
    list.classList.remove('show');
  }
});
</script>
</body>
</html>

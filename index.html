<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>เข้าร่วมกิจกรรม</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@600;800&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Prompt',sans-serif;background:#f5f8ff;display:flex;justify-content:center;padding:15px 10px;min-height:100vh}
        .c{background:#fff;max-width:500px;width:100%;border-radius:24px;box-shadow:0 20px 50px rgba(0,48,135,.25);overflow:hidden}
        .h{background:linear-gradient(135deg,#003087,#0052cc);color:#fff;padding:35px 20px;text-align:center}
        .h h2{font-size:2.2rem;font-weight:800}
        .ct{padding:30px 25px 40px}
        #i{width:100%;padding:24px 20px;font-size:1.7rem;border:3px solid #ddd;border-radius:20px;transition:border .15s}
        #i:focus{outline:none;border-color:#0066ff;box-shadow:0 0 0 5px rgba(0,102,255,.25)}
        #confirmBtn{margin-top:20px;width:100%;padding:24px;font-size:1.9rem;font-weight:800;background:#00c853;color:white;border:none;border-radius:20px;cursor:pointer;opacity:0.3;
            transition:all .2s;will-change:transform,opacity}
        #confirmBtn.active{opacity:1;transform:translateY(-3px);box-shadow:0 15px 40px rgba(0,200,83,.5)}
        #confirmBtn:active{transform:scale(0.96)}
        #r{position:absolute;top:100%;left:50%;transform:translateX(-50%);width:calc(100% - 40px);max-height:58vh;background:#fff;
            border-radius:18px;border:4px solid #0066ff;box-shadow:0 20px 50px rgba(0,0,0,.3);overflow-y:auto;z-index:9999;
            opacity:0;visibility:hidden;will-change:transform,opacity;transition:transform .15s ease,opacity .15s}
        #r.show{opacity:1;visibility:visible;transform:translateX(-50%) translateY(6px)}
        .ri{padding:22px 26px;border-bottom:1px solid #eee;cursor:pointer;transition:background .1s}
        .ri:hover{background:#e3f2fd}
        .ri:active{background:#bbdefb}
        .ri.selected{background:#0066ff!important;color:white}
        .n{font-size:1.45rem;font-weight:800}
        .d{font-size:1.2rem;margin-top:4px;opacity:0.9}
        #res{margin-top:25px;padding:20px;border-radius:16px;text-align:center;font-size:1.3rem;font-weight:600;min-height:70px}
        .info{background:#fff8e1;color:#ff6d00;border:2px solid #ffe082}
        .success{background:#e8f5e8;color:#155724;border:2px solid #c3e6cb}
        .error{background:#fdecea;color:#c62828;border:2px solid #ef9a9a}
        .loading{background:#ebf3ff;color:#003087;border:2px dashed #90caf9}
    </style>
</head>
<body>
<div class="c">
  <div class="h"><h2>เข้าร่วมกิจกรรม</h2></div>
  <div class="ct">
    <div style="position:relative">
      <input type="text" id="i" placeholder="ชื่อหรือรหัสพนักงาน" autocomplete="off" autofocus>
      <ul id="r"></ul>
    </div>
    <button id="confirmBtn">ลงทะเบียน</button>
    <div id="res" class="info">พิมพ์ชื่อหรือรหัสพนักงาน</div>
  </div>
</div>

<script>
// ====== เวอร์ชันเร็วที่สุดในจักรวาล ======
const URL = "https://script.google.com/macros/s/AKfycbzb6vYis20nG_t3vVSqg8GoEi-N8dPWXMC1Vis_vWYW7duvdKnIFl0mfsx10KWqVoSJ/exec";
const input = document.getElementById('i');
const list = document.getElementById('r');
const btn = document.getElementById('confirmBtn');
const res = document.getElementById('res');

let selected = null;
const cache = new Map(); // cache คำค้น 5 วินาที

input.addEventListener('input', () => search()); // 0ms debounce!

input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && selected) {
    e.preventDefault();
    btn.click();
  }
});

btn.onclick = () => selected && checkin(selected.id, selected.name, selected.dept);

async function search() {
  const q = input.value.trim();
  list.innerHTML = '';
  list.classList.remove('show');
  selected = null;
  btn.classList.remove('active');
  btn.textContent = "ลงทะเบียน";

  if (!q) { res.textContent = "พิมพ์ชื่อหรือรหัส"; res.className = "info"; return; }

  // ใช้ cache
  const cacheKey = q.toLowerCase();
  if (cache.has(cacheKey)) {
    renderResults(cache.get(cacheKey));
    return;
  }

  res.textContent = "กำลังค้นหา...";
  res.className = "loading";

  try {
    const r = await fetch(`${URL}?action=search&q=${encodeURIComponent(q)}&t=${Date.now()}`);
    const data = await r.json();
    cache.set(cacheKey, data);
    setTimeout(() => cache.delete(cacheKey), 5000); // cache 5 วิ
    renderResults(data);
  } catch(e) {
    res.textContent = "ไม่พบหรือเน็ตมีปัญหา";
    res.className = "error";
  }
}

function renderResults(data) {
  if (!data || data.length === 0) {
    res.textContent = "ไม่พบข้อมูล";
    res.className = "error";
    return;
  }

  list.innerHTML = '';
  data.slice(0,8).forEach(p => {  // แสดงแค่ 8 คนเร็วสุด
    const li = document.createElement('li');
    li.className = 'ri';
    li.innerHTML = `<div class="n">${p.name}</div><div class="d">รหัส ${p.id} • ${p.dept}</div>`;
    li.onclick = () => selectPerson(p, li);
    list.appendChild(li);
  });
  list.className = 'show';
  res.textContent = `พบ ${data.length} คน ▸ แตะชื่อแล้วกดปุ่มเขียว`;
  res.className = "info";
}

function selectPerson(p, el) {
  selected = p;
  input.value = p.name;
  list.querySelectorAll('.ri').forEach(x => x.classList.remove('selected'));
  el.classList.add('selected');
  list.classList.remove('show');
  btn.classList.add('active');
  btn.innerHTML = `ลงทะเบียน: ${p.name.split(' ')[0]} (${p.id})`;
  res.innerHTML = `<strong>เลือกแล้ว:</strong> ${p.name} • ${p.dept}`;
  res.className = "success";
}

async function checkin(id, name, dept) {
  btn.disabled = true;
  btn.textContent = "กำลังบันทึก...";
  res.innerHTML = `บันทึก ${name}...`;
  res.className = "loading";

  try {
    const r = await fetch(`${URL}?action=checkin&id=${id}&t=${Date.now()}`);
    const json = await r.json();
    if (json.status === 'success') {
      res.innerHTML = `<div style="font-size:4.5rem;color:#00c853">✓</div>
                       <div style="font-size:2rem;font-weight:800;margin:10px 0">${name}</div>
                       <div style="font-size:1.4rem">ลงทะเบียนสำเร็จ!</div>`;
      res.className = "success";

      setTimeout(resetForm, 450); // เร็วสุด 0.45 วินาที!
    } else throw json.message;
  } catch(e) {
    res.textContent = "ผิดพลาด ลองใหม่";
    res.className = "error";
    btn.disabled = false;
    btn.textContent = "ลงทะเบียน";
  }
}

function resetForm() {
  input.value = '';
  selected = null;
  btn.classList.remove('active');
  btn.textContent = "ลงทะเบียน";
  btn.disabled = false;
  res.textContent = "พิมพ์ชื่อหรือรหัสพนักงาน";
  res.className = "info";
  input.focus();
}

// ปิด dropdown นอกพื้นที่
document.addEventListener('click', e => {
  if (!e.target.closest('#i') && !e.target.closest('#r')) list.classList.remove('show');
});
</script>
</body>
</html>
